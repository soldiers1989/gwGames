<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sojson.common.dao.UTbVipRecordMapper" >
  <resultMap id="CountLevel" type="com.sojson.common.model.vo.VipRecordCount" >
      <result column="NAME" property="name" jdbcType="VARCHAR" />
    <result column="INVITAION_CODE" property="invitaionCode" jdbcType="VARCHAR" />
    <result column="LEVEL" property="level" jdbcType="TINYINT" />
    <result column="countNum" property="countNum" jdbcType="INTEGER" />
      <result column="countMoney" property="countMoney" jdbcType="INTEGER" />
  </resultMap>

    <resultMap id="recordMap" type="com.sojson.common.model.TbVipRecord" >
        <result column="id" property="id" jdbcType="INTEGER" />
        <result column="vip_id" property="vipId" jdbcType="VARCHAR" />
        <result column="level" property="level" jdbcType="TINYINT" />
        <result column="crt_time" property="crtTime" jdbcType="VARCHAR" />
        <result column="amount" property="amount" jdbcType="VARCHAR" />
        <result column="remark" property="remark" jdbcType="VARCHAR" />
    </resultMap>

    <resultMap id="recordVoMap" type="com.sojson.common.model.vo.TbVipRecordVo" >
        <result column="id" property="id" jdbcType="INTEGER" />
        <result column="vip_id" property="vipId" jdbcType="VARCHAR" />
        <result column="level" property="level" jdbcType="TINYINT" />
        <result column="crt_time" property="crtTime" jdbcType="VARCHAR" />
        <result column="amount" property="amount" jdbcType="VARCHAR" />
        <result column="remark" property="remark" jdbcType="VARCHAR" />
        <result column="nickname" property="nickname" jdbcType="VARCHAR" />
    </resultMap>

  <select id="countByCode" resultMap="CountLevel" >
    select t.INVITAION_CODE,v.level,count(v.id) countNum,SUM(v.amount) countMoney from tb_vip t INNER JOIN tb_vip_record v on t.id = v.vip_id
    <include refid="where_count"/>
    GROUP BY t.INVITAION_CODE,v.level
  </select>

  
  <sql id="where_count">
  	<where>
  	  <if test="bgnMonth != null and bgnMonth !='' " >
        and v.CRT_TIME &gt;= #{bgnMonth}
      </if>
      <if test="endMonth != null and endMonth !='' " >
        and v.CRT_TIME &lt;= #{endMonth}
      </if>
      <if test="bgnTime != null and bgnTime !=''">
        and v.CRT_TIME   &gt;= #{bgnTime}
      </if>
      <if test="endTime != null and endTime !=''">
        and v.CRT_TIME   &lt;= #{endTime}
      </if>
     </where>
  </sql>

    <select id="findAll" parameterType="map" resultMap="recordVoMap" >
        <if test="search == '1'">
            SELECT * from tb_vip_record;
        </if>

        <if test="search == '2'">
            SELECT * FROM tb_vip_record WHERE vip_id IN(
            SELECT id FROM tb_vip WHERE INVITAION_CODE IN(
            SELECT INVITE_NUM FROM tb_dealer WHERE SEAT_NUM=#{seatNum}));
        </if>

        <if test="search == '3'">
            SELECT * FROM tb_vip_record WHERE vip_id IN(
            SELECT id FROM tb_vip WHERE INVITAION_CODE = #{inviteCode});
        </if>
    </select>

    <select id="findCount" parameterType="map" resultType="int" >
        <if test="search == '1'">
            SELECT count(id) from tb_vip_record;
        </if>

        <if test="search == '2'">
            SELECT count(id) FROM tb_vip_record WHERE vip_id IN(
            SELECT id FROM tb_vip WHERE INVITAION_CODE IN(
            SELECT INVITE_NUM FROM tb_dealer WHERE SEAT_NUM=#{seatNum}));
        </if>

        <if test="search == '3'">
            SELECT count(id) FROM tb_vip_record WHERE vip_id IN(
            SELECT id FROM tb_vip WHERE INVITAION_CODE = #{inviteCode})
        </if>
    </select>

    <select id="findByPageAdminCount" parameterType="map" resultType="int">
        SELECT count(id) from tb_vip_record;
    </select>

    <select id="findByPageDealerCount" parameterType="map" resultType="int">
        SELECT count(id) FROM tb_vip_record WHERE vip_id IN(
            SELECT id FROM tb_vip WHERE INVITAION_CODE IN(
            SELECT INVITE_NUM FROM tb_dealer WHERE SEAT_NUM=#{seatNum}));
    </select>

    <select id="findByPageEmployeeCount" parameterType="map" resultType="int">
        SELECT count(id) FROM tb_vip_record WHERE vip_id IN(
            SELECT id FROM tb_vip WHERE INVITAION_CODE = #{inviteCode})
    </select>

    <select id="findByPageAdmin" parameterType="map" resultMap="recordVoMap" >
        SELECT r.*,v.nickname as nickname FROM tb_vip_record r LEFT JOIN tb_vip v ON v.id=r.vip_id LIMIT #{start},#{pageSize}
    </select>

    <select id="findByPageDealer" parameterType="map" resultMap="recordVoMap" >
        SELECT r.*,v.nickname as nickname FROM tb_vip_record r
        LEFT JOIN tb_vip v ON r.vip_id=v.id
         WHERE r.vip_id IN(
            SELECT id FROM tb_vip WHERE INVITAION_CODE IN(
            SELECT INVITE_NUM FROM tb_dealer WHERE SEAT_NUM=#{seatNum})) LIMIT #{start},#{pageSize}
    </select>

    <select id="findByPageEmployee" parameterType="map" resultMap="recordVoMap">
        SELECT r.*,v.nickname as nickname FROM tb_vip_record r
        LEFT JOIN tb_vip v ON r.vip_id=v.id
         WHERE r.vip_id IN(
            SELECT id FROM tb_vip WHERE INVITAION_CODE = #{inviteCode}) LIMIT #{start},#{pageSize}
    </select>

    <sql id="where_dealerId">
        <where>
            <if test="dealerId != null and dealerId !='' " >
                and x.ID = #{dealerId} or x.PARENT_ID = #{dealerId}
            </if>
        </where>
    </sql>

    <select id="countByEmployee" resultMap="CountLevel" >
        select a1.NAME,a2.INVITAION_CODE,a2.level,a2.countNum,a2.countMoney from
    (select t.INVITAION_CODE,v.level,count(v.id) countNum,SUM(v.amount) countMoney from tb_vip t INNER JOIN tb_vip_record v on t.id = v.vip_id
        <include refid="where_count"/>
    GROUP BY t.INVITAION_CODE,v.level) a2
        LEFT JOIN (select x.NAME,x.INVITE_NUM from tb_dealer x <include refid="where_dealerId"/>) a1
        on a1.INVITE_NUM = a2.INVITAION_CODE
    </select>

    <insert id="addRecord" useGeneratedKeys="true" keyProperty="id" parameterType="com.sojson.common.model.TbVipRecord" >
        insert into tb_vip_record (id,vip_id,level,crt_time,amount,remark)
        values (#{id},#{vipId},#{level},now(),#{amount},#{remark})
    </insert>

    <select id="findAllRecord" resultMap="recordMap" parameterType="map">
      SELECT * FROM tb_vip_record r LEFT JOIN tb_vip v ON v.id=r.vip_id WHERE v.phone=#{phone}
    </select>


</mapper>
